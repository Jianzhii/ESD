<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap CSS -->
  <script src="https://code.jquery.com/jquery-3.6.0.slim.js"
    integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
    integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>

  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script>
    sessionStorage.setItem('prev', 'index.html');
    // console.log(sessionStorage.getItem('user_id'));
    //console.log(sessionStorage.getItem('prev'));
  </script>
  <link rel="shortcut icon" type="image/png" href="stonks.png" />
  <title>Market Report</title>
  <!-- Bootstrap core CSS -->
  <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table td {
      text-align: center;
    }

    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  <!-- Custom styles for this template -->
  <link href="dashboard.css" rel="stylesheet">
</head>


<body>

  <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="index.html">$tonks manager</a>
    <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse"
      data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <input class="form-control form-control-dark w-100" type="text" id="search" placeholder="Search Stock ID"
      aria-label="Search">
    <ul class="navbar-nav px-3">
      <li class="nav-item text-nowrap">
        <span id="signedin">
        </span>
      </li>
    </ul>
  </header>

  <div class="container-fluid">
    <div class="row">
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light nav-sidebar collapse">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="index.html">
                <span data-feather="home"></span>
                Market
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">
                <span data-feather="bar-chart-2"></span>
                My Dashboard
              </a>
            </li>
      </nav>

      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-center">
          <h1 class="h2">Market Report</h1>
        </div>

        <h2>Top 10 Gainers</h2>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Stock ID</th>
                <th scope="col">Name</th>
                <th scope="col">Price</th>
                <th scope="col">Change</th>
                <th scope="col">Market Cap</th>
              </tr>
            </thead>
            <tbody id='gainers'>
              <tr id='g1'></tr>
              <tr id='g2'></tr>
              <tr id='g3'></tr>
              <tr id='g4'></tr>
              <tr id='g5'></tr>
              <tr id='g6'></tr>
              <tr id='g7'></tr>
              <tr id='g8'></tr>
              <tr id='g9'></tr>
              <tr id='g10'></tr>
            </tbody>
          </table>
        </div>

        <h2>Top 10 Losers</h2>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Stock ID</th>
                <th scope="col">Name</th>
                <th scope="col">Price</th>
                <th scope="col">Change</th>
                <th scope="col">Market Cap</th>
              </tr>
            </thead>
            <tbody id='losers'>
              <tr id='l1'></tr>
              <tr id='l2'></tr>
              <tr id='l3'></tr>
              <tr id='l4'></tr>
              <tr id='l5'></tr>
              <tr id='l6'></tr>
              <tr id='l7'></tr>
              <tr id='l8'></tr>
              <tr id='l9'></tr>
              <tr id='l10'></tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>


  <script src="../assets/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"
    integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"
    integrity="sha384-zNy6FEbO50N+Cg5wap8IKA4M/ZnLJgzc6w2NqACZaK0u0FXfOWRRJOnQtpZun8ha"
    crossorigin="anonymous"></script>
  <script src="dashboard.js"></script>
</body>

<script>
  if (sessionStorage.getItem('user_id') != null) {
    name = sessionStorage.getItem('name').split(" ", 1);
    document.getElementById('signedin').innerHTML = "<a class='nav-link' href='signout.html'> Welcome " + name + "</a>"
  } else {
    document.getElementById('signedin').innerHTML = "<a class='nav-link' href='signin.html'>Sign in</a>"
  }

  var search = document.getElementById("search");

  search.addEventListener("keyup", function (event) {
    // Number 13 is the "Enter" key on the keyboard
    if (event.keyCode === 13) {
      // Cancel the default action, if needed
      event.preventDefault();
      var input = document.getElementById("search").value;
      alert("Searching for: " + input)
      search_stock(input)

    }
  });

  // Function to check if stock exist
  function search_stock(input) {
    $(async () => {
      var stock_id = document.getElementById('search').value;
      // API Gateway
      var stockInfo_url = "http://127.0.0.1:8000/stock/" + input;

      // Non-API Gateway
      // var stockInfo_url = "http://127.0.0.1:5900/stock/" + symbol;

      try {
        const response =
          await fetch(
            stockInfo_url, { method: 'GET' }
          );

        const result = await response.json();
        if (response.status === 200) {

          sessionStorage.setItem('stock_id', stock_id);
          window.location.href = "stock.html";

        }

        else if (response.status == 500) {
          alert(`${input} do not exist`);
        }
        else {
          throw response.status;
        }
      }

      catch (error) {
        showError
          (`There is a problem retrieving ${sessionStorage.getItem('id')} data, please try again later.<br />` + error);
      }

    });

  }
</script>

<script>


  // Calling market information microservice
  $(async () => {
    var stockID_url = "http://127.0.0.1:8000/market";

    // Non-API Gateway
    // var stockInfo_url = "http://127.0.0.1:5900/market";

    try {
      const response =
        await fetch(
          stockID_url, { method: 'GET' }
        );

      const result = await response.json();
      if (response.status === 200) {

        var gainers = result.results.gainers;
        counter = 1
        for (gainer of gainers) {
          // Calling stock information microservice 
          id = '#g' + counter
          $(id).stocks_info(gainer['symbol'], counter);
          counter += 1

        }

        var losers = result.results.losers;
        counter = 1;
        for (loser of losers) {
          // Calling stock information microservice
          id = '#l' + counter.toString();
          $(id).stocks_info(loser['symbol'], counter);
          counter += parseInt(1);
        }
      }
      else if (response.status == 500) {
        showError(result.message);
      }
      else {
        throw response.status;
      }
    }

    catch (error) {
      showError
        ('There is a problem retrieving market data, please try again later.<br />' + error);
    }


  });


  (function ($) {
    $.fn.stocks_info = function (symbol, counter) {
      $(async () => {

        // API Gateway
        var stockInfo_url = "http://127.0.0.1:8000/stock/" + symbol;

        // Non-API Gateway
        // var stockInfo_url = "http://127.0.0.1:5900/stock/" + symbol;

        try {
          const info_response =
            await fetch(
              stockInfo_url, { method: 'GET' }
            );

          const info_result = await info_response.json();
          if (info_response.status === 200) {
            var stock_info = info_result.results;

            change = (((parseFloat(stock_info['historical_data']['one_day']['price']) - parseFloat(stock_info['previousClose'])) / parseFloat(stock_info['previousClose'])) * 100).toFixed(2);

            if (change > 0) {
              id = 'g_change'
            }
            else {
              id = 'l_change'
            };

            if (stock_info['name'] == null) {
              stock_info['name'] = symbol;
            }
            if (stock_info['marketCap'] == null) {
              stock_info['marketCap'] = 'N/A'
            }

            var row = '';
            row += "<td>" + counter + "</td>"
            if (change >= 0) {
              row += "<td> <button type='button' class='btn btn-success symbol' onclick='send_stock_id(this)'>" + symbol + "</button></td>"
            } else {
              row += "<td> <button type='button' class='btn btn-danger symbol' onclick='send_stock_id(this)'>" + symbol + "</button></td>"
            }

            row += "<td>" + stock_info['name'] + "</td>" +
              "<td> $" + stock_info['previousClose'].toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + "</td>" +
              "<td id=" + id + ">" + change + "% </td>" +
              "<td>" + stock_info['marketCap'].toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",") + "</td>";
            this.append(row);
          }
          else if (info_response.status == 500) {
            showError(info_result.message);
          }
          else {
            throw info_response.status;
          }
        }

        catch (error) {
          showError
            (`There is a problem retrieving ${symbol} data, please try again later.<br />` + error);
        }
      })
    }
  })(jQuery);

  function showError(message) {
    $('#error').append("<label style='color:red; text-align:center'>" + message + "</label>");
  }


  function send_stock_id(tag) {
    var stock_id = tag.innerText;
    sessionStorage.setItem('stock_id', stock_id);
    window.location.href = "stock.html";
  }

</script>

</html>