<!DOCTYPE html>
<html>

<head>

    <title>Stonks Exchange</title>

    <!-- CSS (Use this section if you need to) -->

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
    integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>


        <!-- jQuery first, then Popper.js, then Bootstrap JS
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script> -->

    <style>
        /* YOUR CSS CODE GOES HERE */

        #down{
            color: red;
        }

        h4 {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        #main {
            margin: auto;
            width: 80%;
        }

        .flex-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

        #warning{
            justify-content: center;
        }

        #g_change {
            color: green;
        }

        #l_change{
            color: red;
        }

        .symbol:hover {
            color: blue;
            cursor: pointer ;

        }

        h1 {
            text-align: center;
            margin: 15px ;
            font-weight: bold ;
        }

        h2 {
            text-align: center ;
            font-weight: bold ;
            margin: 20px ;
        }
        
    </style>

</head>

<body>
    <!-- YOUR CODE GOES HERE -->

        <div class="container" id="main">
            <h1 id="welcome">Welcome to Stonks Exchange, </h1>
            <div class="container">
                <div class="row">
                    <div class="col-sm-5">
                        <div class="card bg-light mb-3 h-100">
                            <div class="card-header" style='font-size:26px ; text-align: center;'>
                                <i class="fas fa-user-circle" style='font-size:36px'></i>
                                Personal Information</i>
                            </div>
                            <div class="card-body">
                                <p class="container" id="userid">User Id: </p>
                                <p class="container" id="email">Email Address: </p>
                              <p class="card-text"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-7">
                        <div class="card bg-light mb-3 h-100">
                            <div class="card-header" style='font-size:26px ; text-align: center'>
                                <i class='fas fa-piggy-bank' style='font-size:36px'></i>Your Wallet
                            </div>
                            <div class="card-body">
                              <p class="card-text" id="left">
                                    Amount Left: $
                              </p>
                              <p class="card-text" id="spent">
                                    Amount Spent: $
                              </p>
                            </div>
                        </div>
                    </div>
                </div>

            <div class="container">
                <h2>Your Stonks</h2>
                <table class="table" id="stocks">
                    <thead class="thead-light">
                      <tr>
                        <th scope="col">Name of Stock</th>
                        <th scope="col">Price of Stock</th>
                        <th scope="col">Quantity of Stock</th>
                        <th scope="col">Position of Stock</th>
                      </tr>
                  </table>
        </div>
        </div>
      

      <script>
        
        $(async() => {     
            // var user_id = '102619348770476669264'

            // Testing
            var user_id = 'Apple Tan'

            // API Gateway
            var userprofileURL = "http://localhost:8000/userprofile/" + user_id; 

            // Non-API Gateway
            // var userprofileURL = "http://localhost:5008/userprofile/" + user_id; 

            try {
                const response =
                await fetch(
                    userprofileURL, {
                        method: 'GET'
                    }
                );

                const result = await response.json();
                if (response.status === 200) {

                    var name = result.user_information.data.profile_result.profile.name
                    var userid = result.user_information.data.profile_result.profile.user_id
                    var email = result.user_information.data.profile_result.profile.email

                    $('#welcome').append(name)
                    $('#userid').append(userid)
                    $('#email').append(email)

                    var balance = result.user_information.data.funds_result.fund.balance
                    var spent = result.user_information.data.funds_result.fund.spent
                    $('#left').append(balance)
                    $('#spent').append(spent)

                    // to retrieve the price and quantity of stocks under user
                    var stocks = result.user_information.data.portfolio_result.stocks
                    console.log(stocks)
                    var stocks_array = []

                    var market_stocks = result.user_stocks.data.stock_results
                    var market_prices = []

                    for (market_stock in market_stocks) {
                        market_price = market_stocks[market_stock]['results']['historical_data']['one_day']['price'][0] ;
                        market_prices.push(market_price)
                    }

                    var overall_value = 0
                    var position = ""
                    var rows = ""
 
                    // to go into the json object
                    for (var i = 0 ; i < market_prices.length ; i++) {
                        var stock = stocks[i]
                        console.log(stock)
                        eachRow = "<td>" + stock.stock_id + "</td>" +
                                  "<td>" + stock.price + "</td>" +
                                  "<td>" + stock.quantity + "</td>"
                        stocks_array.push([stock.price, stock.quantity])
                        console.log(eachRow)

                        
                        difference = (market_prices[i] - stocks_array[i][0]) * stocks_array[i][1]
                        overall_value += difference
                        if (market_prices[i] > stocks_array[i][0]) {
                            eachRow += "<td style='color: green'>gain</td>"
                        }
                        else { 
                            eachRow += "<td style='color: red'>loss</td>"
                        }

                        console.log(eachRow)
                        
                        rows += "<tbody><tr>" + eachRow + "</tr></tbody>" ;
                    }

                    rows += "<tr><td><td><th>Overall Profit/Loss:<td>" + overall_value + "</td></th></td></td>"
                    $('#stocks').append(rows)                    
                    overall_value = Math.round(overall_value, 2)
                    $('#overall').append(overall_value) ;

                }

                else if (response.status == 404) {
                    showError(result.message) ;
                } else {
                    throw response.status ;
                }
                
            } catch (error) {
                showError
                ('There is a problem retrieving your portfolio, please try again later.<br />' + error); 
            }
        });

          function showError(message) {
            $('#error').append("<label style='color:red; text-align:center'>"+message+"</label>");
          };
          
      </script>


</body>

</html>